<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>"小球连线动画"</title>
    <script type="text/javascript" src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
</head>

<body>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width = window.innerWidth;
        const height = canvas.height = window.innerHeight;

        class Ball {
            constructor(x, y, velX, velY, color, size) {
                this.x = x;
                this.y = y;
                this.velX = velX;
                this.velY = velY;
                this.color = color;
                this.size = size;
            }
            draw() {
                ctx.beginPath();
                ctx.fillStyle = this.color;
                ctx.arc(this.x, this.y, this.size, 0, 2 * Math.PI);
                ctx.fill();
            }
            update() {
                if ((this.x + this.size) >= width) {
                    this.velX = -(this.velX);
                }
                if ((this.x - this.size) <= 0) {
                    this.velX = -(this.velX);
                }
                if ((this.y + this.size) >= height) {
                    this.velY = -(this.velY);
                }
                if ((this.y - this.size) <= 0) {
                    this.velY = -(this.velY);
                }
                this.x += this.velX;
                this.y += this.velY;
            }
        }
        function random(m, n) {
            //随机生成[m,n]的整数
            return Math.floor(Math.random() * (n - m + 1)) + Math.floor(m);
        }
        function distance(x1, y1, x2, y2) {
            //计算两个坐标间的距离
            return Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2));
        }
        function drawLine(x1, y1, x2, y2, color) {
            //画直线的函数
            ctx.beginPath();
            ctx.strokeStyle = color;//线的粗细
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
        }
        function randomColor() {
            //返回随机颜色值RGB(有任意实参，返回RGBA值)
            let red = Math.floor(Math.random() * 256);
            let green = Math.floor(Math.random() * 256);
            let blue = Math.floor(Math.random() * 256);
            let alpha = 0.9 * Math.random() + 0.1;//设置alpha最低为0.1，最高值为1
            let color = "rgb(" + red + "," + green + "," + blue + ")";
            let color_alpha = "rgba(" + red + "," + green + "," + blue + "," + alpha + ")";
            if (arguments.length != 0) {//如果实参不为空，则返回RGBA值
                return color_alpha;
            }
            else {
                return color;//默认返回RGB值
            }
        }
        function genBallsList() {
            //生成小球列表
            while (balls.length < BALL_COUNTS) {
                let size = random(5, 6);
                let φ = random(0, 360) * Math.PI / 180; //运动方向角
                let v = 0.1 + 0.9 * Math.random();//速度大小，取值范围[0.1,1]
                let ball = new Ball(
                    // 为避免绘制错误，球生成的位置至少离画布边缘球本身一倍宽度的距离
                    random(0 + size, width - size),
                    random(0 + size, height - size),
                    v * Math.cos(φ) * SPEED_FACTOR,
                    v * Math.sin(φ) * SPEED_FACTOR,
                    randomColor(),
                    size
                );
                balls.push(ball);
            }
            return balls;
        }

        var balls = [];
        var BALL_COUNTS = 150;//小球个数
        var SPEED_FACTOR = 1;//小球速度倍数，调整小球速度。
        balls = genBallsList();

        function loop() {
            //循环绘制背景、小球和连线
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';//背景的alpha值能影响小球运动残影
            ctx.fillRect(0, 0, width, height);//每一帧都重绘背景 

            for (let i = 0; i < balls.length; i++) {
                //逐个绘制小球
                balls[i].draw();
                balls[i].update();
                for (let j = 0; j < balls.length; j++) {
                    //两两判断距离，并绘制连线
                    if (j != i) {
                        if (distance(balls[i].x, balls[i].y, balls[j].x, balls[j].y) <= 70) {
                            drawLine(balls[i].x, balls[i].y, balls[j].x, balls[j].y, randomColor(1));
                        }
                    }
                }
            }

            requestAnimationFrame(loop);
        }
        loop();

        canvas.addEventListener("click", click);
        function click(event) {
            var mouseX = event.clientX - canvas.offsetLeft;
            var mouseY = event.clientY - canvas.offsetTop;
            var θ;
            for (let i = 0; i < balls.length; i++) {
                var dist = distance(balls[i].x, balls[i].y, mouseX, mouseY);
                if (dist <= 100) {
                    //console.log(i);
                    balls[i].velX = (balls[i].velX);
                    balls[i].velY = (balls[i].velY);
                    θ = Math.atan2(balls[i].y - mouseY, balls[i].x - mouseX);
                    var moveto_PosY = mouseY + 100 * Math.sin(θ);
                    var moveto_PosX = mouseX + 100 * Math.cos(θ);
                    if (moveto_PosY <= 0 + balls[i].size) {
                        moveto_PosY = 0 + balls[i].size;
                    }
                    if (moveto_PosY >= height - balls[i].size) {
                        moveto_PosY = height - balls[i].size;
                    }
                    if (moveto_PosX <= 0 + balls[i].size) {
                        moveto_PosX = 0 + balls[i].size;
                    }
                    if (moveto_PosX >= width - balls[i].size) {
                        moveto_PosX = width - balls[i].size;
                    }
                    /*if (moveto_PosX > balls[i].size && moveto_PosX < width - balls[i].size && moveto_PosY > balls[i].size && moveto_PosY < height - balls[i].size) {*/
                        balls[i].y = moveto_PosY;
                        balls[i].x = moveto_PosX;
                    /*}*///有BUG
                }
            }
        }
        //canvas.removeEventListener("click", click);
    </script>
</body>

</html>